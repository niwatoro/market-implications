<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Real-time market implications dashboard displaying JPX OIS settlement rates, BoJ rate hike probabilities, and JSDA bond transaction prices.">
    <title>J-RATE INSIGHTS | Tokyo Market Intelligence</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>J-RATE INSIGHTS</h1>
            <h2 class="subtitle">JPX OIS &amp; JSDA BOND ANALYTICS</h2>
        </header>

        <main>
            {% if data %}
            <div class="info-bar">
                <div>
                    <span class="status-live"></span>
                    <span>LIVE DATA</span>
                </div>
                <div class="date">
                    Latest Update: {{ data.latest_date }}
                </div>
            </div>
            {% endif %}

            {% if not data %}
            <div class="card">
                <div class="loading">NO DATA AVAILABLE - PLEASE RUN INGESTION SCRIPT</div>
            </div>
            {% else %}

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('probability')">RATE PROBABILITY</button>
                <button class="tab-btn" onclick="switchTab('curve')">YIELD CURVE</button>
                <button class="tab-btn" onclick="switchTab('credit')">DEFAULT PROBS</button>
            </div>

            <section id="view-probability" class="view-section">
                <div class="card">
                    {% if data and data.rate_probabilities %}
                    <div class="card-header">
                        BOJ RATE PROBABILITY - NEXT MEETING: {{ data.rate_probabilities.next_meeting_date }}
                    </div>
                    <div class="chart-container">
                        <canvas id="probabilityChart"></canvas>
                    </div>
                    <div style="padding: 1rem; background: #0a0a0a; border-top: 1px solid #333333;">
                        <div
                            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.85rem;">
                            <div>
                                <span style="color: #999999;">CURRENT RATE:</span>
                                <span style="color: #FF7F00; font-weight: bold; margin-left: 0.5rem;">{{
                                    "%.3f"|format(data.rate_probabilities.current_rate) }}%</span>
                            </div>
                            <div>
                                <span style="color: #999999;">IMPLIED RATE:</span>
                                <span style="color: #FF7F00; font-weight: bold; margin-left: 0.5rem;">{{
                                    "%.3f"|format(data.rate_probabilities.implied_rate) }}%</span>
                            </div>
                            <div>
                                <span style="color: #999999;">DAYS TO MEETING:</span>
                                <span style="color: #FF7F00; font-weight: bold; margin-left: 0.5rem;">{{
                                    data.rate_probabilities.days_to_meeting }}</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="card-header">BOJ RATE PROBABILITY</div>
                    <div class="loading">NO MEETING DATA AVAILABLE</div>
                    {% endif %}
                </div>
            </section>

            <section id="view-curve" class="view-section" style="display: none;">
                <div class="card">
                    <div class="card-header">JPX OIS & JGB YIELD CURVES</div>
                    <div class="chart-container">
                        <canvas id="oisChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="view-credit" class="view-section" style="display: none;">
                <div class="card">
                    <div class="card-header">CORPORATE DEFAULT PROBABILITIES (IMPLIED)</div>
                    {% if data and data.credit_data %}
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ISSUER</th>
                                    <th>BONDS</th>
                                    <th>AVG SPREAD (bps)</th>
                                    <th>PD 1Y (%)</th>
                                    <th>PD 3Y (%)</th>
                                    <th>PD 5Y (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in data.credit_data %}
                                <tr>
                                    <td style="color: #FF7F00; font-weight: bold;">{{ row.issuer }}</td>
                                    <td>{{ row.n_bonds }}</td>
                                    <td>{{ "{:.2f}".format(row.avg_spread_bps) }}</td>
                                    <td>{{ "{:.2f}".format(row.pd_1y) }}</td>
                                    <td>{{ "{:.2f}".format(row.pd_3y) }}</td>
                                    <td>{{ "{:.2f}".format(row.pd_5y) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="loading">NO CREDIT DATA AVAILABLE</div>
                    {% endif %}
                </div>
            </section>

            {% endif %}
        </main>

        <footer class="footer">
            DATA SOURCE: JPX JSCC SETTLEMENT RATES, JSDA BOND TRANSACTION PRICES
        </footer>
    </div>

    <script>
        {% if data %}
        const rawData = {{ data.curve | tojson }};
        const jgbData = {{ data.jgb_curve | tojson }};

        // Prepare Chart Data for OIS
        const labels = rawData.map(d => d.tenor);
        const rates = rawData.map(d => d.rate);

        // Prepare JGB data
        const jgbLabels = jgbData.map(d => d.tenor);
        const jgbRates = jgbData.map(d => d.rate);

        const ctx = document.getElementById('oisChart').getContext('2d');

        // Bloomberg-style gradient for OIS
        const gradient = ctx.createLinearGradient(0, 0, 0, 450);
        gradient.addColorStop(0, 'rgba(255, 127, 0, 0.3)');
        gradient.addColorStop(1, 'rgba(255, 127, 0, 0.0)');

        // Build datasets array
        const datasets = [
            {
                label: 'OIS Rate (%)',
                data: rates,
                borderColor: '#FF7F00',
                backgroundColor: gradient,
                borderWidth: 2.5,
                fill: true,
                tension: 0.1,
                pointBackgroundColor: '#000000',
                pointBorderColor: '#FF7F00',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointHoverBackgroundColor: '#FF7F00',
                pointHoverBorderColor: '#FFFFFF',
                pointHoverBorderWidth: 2
            }
        ];

        // Add JGB dataset if data exists
        if (jgbData && jgbData.length > 0) {
            datasets.push({
                label: 'JGB Yield (%)',
                data: jgbRates,
                borderColor: '#4A90E2',
                backgroundColor: 'transparent',
                borderWidth: 2.5,
                borderDash: [5, 5],
                fill: false,
                tension: 0.1,
                pointBackgroundColor: '#000000',
                pointBorderColor: '#4A90E2',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointHoverBackgroundColor: '#4A90E2',
                pointHoverBorderColor: '#FFFFFF',
                pointHoverBorderWidth: 2
            });
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#CCCCCC',
                            font: {
                                size: 11,
                                family: 'Arial',
                                weight: 'bold'
                            },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#000000',
                        titleColor: '#FF7F00',
                        bodyColor: '#FFFFFF',
                        borderColor: '#FF7F00',
                        borderWidth: 2,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            title: function (context) {
                                return 'TENOR: ' + context[0].label;
                            },
                            label: function (context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(3) + '%';
                            }
                        },
                        titleFont: {
                            size: 11,
                            weight: 'bold',
                            family: 'Arial'
                        },
                        bodyFont: {
                            size: 13,
                            weight: 'bold',
                            family: 'Courier New'
                        }
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: '#1a1a1a',
                            lineWidth: 1
                        },
                        ticks: {
                            color: '#CCCCCC',
                            font: {
                                size: 11,
                                family: 'Courier New'
                            },
                            callback: function (value) {
                                return value.toFixed(3) + '%';
                            }
                        },
                        border: {
                            color: '#333333'
                        }
                    },
                    x: {
                        grid: {
                            color: '#1a1a1a',
                            lineWidth: 1
                        },
                        ticks: {
                            color: '#CCCCCC',
                            font: {
                                size: 10,
                                family: 'Arial',
                                weight: 'bold'
                            }
                        },
                        border: {
                            color: '#333333'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // Probability Chart
        {% if data.rate_probabilities %}
        const probData = {{ data.rate_probabilities | tojson }};
        const currentRate = probData.current_rate;

        // Prepare data for horizontal bar chart
        const scenarios = [];
        const probabilities = [];
        const barColors = [];

        // Add scenarios based on what has non-zero probability
        if (probData.probabilities.hike_25bps > 0) {
            scenarios.push(`${(currentRate + 0.25).toFixed(3)}% (+25bps)`);
            probabilities.push(probData.probabilities.hike_25bps);
            barColors.push('#4A90E2');  // Blue for hike
        }

        if (probData.probabilities.no_change > 0) {
            scenarios.push(`${currentRate.toFixed(3)}% (No Change)`);
            probabilities.push(probData.probabilities.no_change);
            barColors.push('#4A90E2');  // Blue for no change
        }

        if (probData.probabilities.cut_25bps > 0) {
            scenarios.push(`${(currentRate - 0.25).toFixed(3)}% (-25bps)`);
            probabilities.push(probData.probabilities.cut_25bps);
            barColors.push('#4A90E2');  // Blue for cut
        }

        const probCtx = document.getElementById('probabilityChart').getContext('2d');

        new Chart(probCtx, {
            type: 'bar',
            data: {
                labels: scenarios,
                datasets: [{
                    label: 'Probability',
                    data: probabilities,
                    backgroundColor: barColors,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',  // Horizontal bars
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#000000',
                        titleColor: '#FF7F00',
                        bodyColor: '#FFFFFF',
                        borderColor: '#FF7F00',
                        borderWidth: 2,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function (context) {
                                return 'PROBABILITY: ' + context.parsed.x.toFixed(1) + '%';
                            }
                        },
                        titleFont: {
                            size: 11,
                            weight: 'bold',
                            family: 'Arial'
                        },
                        bodyFont: {
                            size: 13,
                            weight: 'bold',
                            family: 'Courier New'
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: '#1a1a1a',
                            lineWidth: 1
                        },
                        ticks: {
                            color: '#CCCCCC',
                            font: {
                                size: 11,
                                family: 'Courier New'
                            },
                            callback: function (value) {
                                return value + '%';
                            }
                        },
                        border: {
                            color: '#333333'
                        }
                    },
                    y: {
                        grid: {
                            color: '#1a1a1a',
                            lineWidth: 1
                        },
                        ticks: {
                            color: '#FFFFFF',
                            font: {
                                size: 12,
                                family: 'Courier New',
                                weight: 'bold'
                            }
                        },
                        border: {
                            color: '#333333'
                        }
                    }
                }
            }
        });
        {% endif %}

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update views
            document.getElementById('view-curve').style.display = 'none';
            document.getElementById('view-probability').style.display = 'none';
            document.getElementById('view-credit').style.display = 'none';
            document.getElementById('view-' + tabName).style.display = 'block';
        }
        {% endif %}
    </script>
</body>

</html>